var dt=Object.defineProperty;var ct=(r,e,t)=>e in r?dt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var o=(r,e,t)=>(ct(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const h of n)if(h.type==="childList")for(const l of h.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(n){const h={};return n.integrity&&(h.integrity=n.integrity),n.referrerPolicy&&(h.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?h.credentials="include":n.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function i(n){if(n.ep)return;n.ep=!0;const h=t(n);fetch(n.href,h)}})();var x=(r=>(r[r.NONE=0]="NONE",r[r.PLUS=1]="PLUS",r[r.MINUS=2]="MINUS",r))(x||{}),m=(r=>(r[r.PIXEL=0]="PIXEL",r[r.CELL=1]="CELL",r))(m||{});const y=class y{constructor(e,t,i=x.NONE,n=m.PIXEL){o(this,"x");o(this,"y");o(this,"sign");o(this,"unit");this.x=e,this.y=t,this.sign=i,this.unit=n}clone(){return new y(this.x,this.y,this.sign)}plus(e){return new y(this.x+e.x,this.y+e.y,this.sign,this.unit)}minus(e){return new y(this.x-e.x,this.y-e.y,x.NONE)}normalizeSign(){const e=this.sign==x.MINUS?-this.x:this.x,t=this.sign==x.MINUS?-this.y:this.y;return new y(e,t,x.NONE,this.unit)}};o(y,"zero",()=>new y(0,0));let d=y;class N{constructor(){o(this,"id","");o(this,"position",d.zero());o(this,"selected",!1);o(this,"visible",!0)}updatePosition(e,t){this.position.x=e,this.position.y=t}}class M extends N{constructor(){super();o(this,"position");o(this,"selected",!1);o(this,"visible",!0);this.id="dummy",this.position=d.zero()}clone(){return new M}draw(t){console.log(`dummy draw on ${t}`)}hitTest(t){return!1}static getInstance(){return new M}}const ut=6,pt=.1,ft=.002,Y="yellow",gt=2,G="courier",F=14,at=1,A="white",O="black",k=["#F44336","#673AB7","#E91E63","#FFC107","#3F51B5","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FF9800","#FF5722","#673AB7","#795548","#2196F3","#9E9E9E","#607D8B"],St=[22,14,16,17,12,32],Et=St[0],_=M.getInstance();class X{constructor(){o(this,"dotAndBox")}updateModel(e){this.dotAndBox=e}move(e){}up(e){}}class R extends N{constructor(t,i,n,h,l,a,c){super();o(this,"color");o(this,"size");o(this,"text");o(this,"id");o(this,"selected");o(this,"visible");this.id=t,this.position=i,this.color=h,this.size=n,this.text=l,this.selected=c,this.visible=a}draw(t){t.beginPath(),t.arc(this.position.x,this.position.y,this.size,0,2*Math.PI,!1),t.fillStyle=this.color,t.fill(),this.selected&&(t.lineWidth=at,t.strokeStyle=Y,t.stroke()),t.closePath();const i=this.text.length>1?this.size*.8:this.size*1.2;t.font=`${i}px ${G}`,t.fillStyle=this.color!=A?A:O;const n=i/2-i/4+1,h=n*this.text.length;t.fillText(this.text,this.position.x-h,this.position.y+n)}hitTest(t){let i=this.position.x-t.x,n=this.position.y-t.y;return i*i+n*n<=this.size*this.size}clone(){return new R(this.id.toString(),this.position.clone(),this.size,this.color.toString(),this.text.toString(),this.visible,this.selected)}}class mt extends X{click(e){const t=this.dotAndBox.model.controls,i=`${t.length+1}`;t.push(new R(i,e,Et,k[t.length%k.length],i,!0,!1)),this.dotAndBox.resetTool()}}class xt extends X{click(e){}move(e){}}class wt extends X{constructor(){super(...arguments);o(this,"dragStart",d.zero())}click(t){this.dragStart=t;const i=[];this.dotAndBox.model.controls.forEach(n=>{n.hitTest(t)&&i.push(n)}),i.length>0&&(i.forEach(n=>n.selected=!n.selected),this.dotAndBox.model.applySelected(i))}move(t){this.dotAndBox.model.offset=new d(t.x-this.dragStart.x,t.y-this.dragStart.y)}}class Q extends N{constructor(t,i,n,h,l,a,c,p){super();o(this,"_center",!1);o(this,"_color","black");o(this,"_fontName",G);o(this,"_fontSize",F);o(this,"_maxWidth",100);o(this,"_maxHeight",100);o(this,"_spanX",0);o(this,"_spanY",0);o(this,"_text");o(this,"_textData");o(this,"drawn",!1);this.position=i,this._fontName=n,this._fontSize=h,this._maxWidth=a,this._maxHeight=c,this._text=t,this._color=l,this._center=p,this._textData=[]}get maxHeight(){return this._maxHeight}set maxHeight(t){this._maxHeight=t}get center(){return this._center}set center(t){this._center=t}get color(){return this._color}set color(t){this._color=t}get fontName(){return this._fontName}set fontName(t){this._fontName=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._textData=[]}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth=t,this._textData=[]}get text(){return this._text}set text(t){this._text!==t&&(this._text=t,this._textData=[])}clone(){return new Q(this._text,this.position,this._fontName,this._fontSize,this._color,this._maxWidth,this._maxHeight,this._center)}updatePosition(t,i){super.updatePosition(t,i),this._textData=[]}draw(t){t.fillStyle=this._color,t.font=`${this._fontSize}px ${this._fontName}`,this._textData.length==0&&this.wrapText(t);let i=0;for(const n of this._textData)t.fillText(n,this.position.x+this._spanX,this.position.y+this._spanY+this._fontSize*i++);this.drawn||(this.drawn=!0)}hitTest(t){return!1}wrapText(t){let i=0,n=0;const h=[],l=this._text.split(`
`);for(let a=0;a<l.length;a++){let c="",p=l[a].split(" ");for(let u=0;u<p.length;u++){let g=c+p[u],b=t.measureText(g).width;b>n&&(n=b),g+=" ",b>this._maxWidth?(h.push(c),c=p[u]+" ",i+=this._fontSize):c=g}h.push(c),i+=this._fontSize}this._center&&(this._spanX=this._maxWidth<n?0:(this._maxWidth-n)/2,this._spanY=(this._maxHeight-h.length*this.fontSize)/2+this.fontSize/2),this._textData=h}}const H=class H extends N{constructor(t,i,n,h,l,a,c,p){super();o(this,"color");o(this,"size");o(this,"_text");o(this,"id");o(this,"selected");o(this,"visible");o(this,"_fontSize");o(this,"textControl");this.id=t,this.position=i,this.size=n,this._fontSize=h,this.color=l,this._text=a,this.selected=p,this.visible=c,this.textControl=new Q(a,this.position,G,this._fontSize,O,this.size.x,this.size.y,!0)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t}get text(){return this._text}set text(t){this._text=t}draw(t){t.fillStyle=this.color!=A?A:O,t.strokeStyle=O,this.color!=A&&(t.fillStyle=this.color,t.fillRect(this.position.x,this.position.y,this.size.x,this.size.y)),(this.selected||this.color!=A)&&(t.strokeStyle=this.selected?Y:O,t.lineWidth=this.selected?gt:at,t.strokeRect(this.position.x,this.position.y,this.size.x,this.size.y)),this.textControl.fontSize=this._fontSize,this.textControl.color=this.color!=A&&this.color!="transparent"?A:O,this.textControl.draw(t)}hitTest(t){const i=t.x,n=t.y;return i>=this.position.x&&i<=this.position.x+this.size.x&&n>=this.position.y&&n<=this.position.y+this.size.y}clone(){return new H(this.id.toString(),this.position.clone(),this.size.clone(),this._fontSize,this.color.toString(),this._text.toString(),this.visible,this.selected)}};o(H,"counter",1);let L=H;class It extends X{constructor(){super(...arguments);o(this,"dragStart",d.zero())}click(t){const i=this.dotAndBox.model.controls;this.dragStart=t;const n=`box ${L.counter++}`;this.dotAndBox.model.controls.push(new L(n,t,new d(this.dotAndBox.model.cellSize,this.dotAndBox.model.cellSize,x.NONE,m.CELL),F,k[i.length%k.length],n,!0,!1)),this.dotAndBox.resetTool()}}var f=(r=>(r[r.START=0]="START",r[r.IN_PROGRESS=1]="IN_PROGRESS",r[r.STOPPED=2]="STOPPED",r[r.END=3]="END",r))(f||{}),E=(r=>(r[r.BACKWARD=0]="BACKWARD",r[r.FORWARD=1]="FORWARD",r[r.NONE=2]="NONE",r))(E||{});class j{constructor(e,t){o(this,"_progress",0);o(this,"actions",[]);o(this,"_start",0);o(this,"_end",1);o(this,"_startEndDiff",1);this._start=e,this._end=t,this.calcDiff()}get start(){return this._start}get end(){return this._end}calcDiff(){this._startEndDiff=this._end-this._start}updateStartEnd(e,t){this._start=e,this._end=t,this.calcDiff()}set progress(e){let t;if(e<=this.start?t=0:e>=this.end?t=1:t=(e-this.start)/this._startEndDiff,this._progress!==t){t>0&&this._progress==0?this.actions.forEach(i=>i.onBeforeForward()):t==0&&this._progress>0&&this.actions.forEach(i=>i.onAfterBackward()),this._progress=t;for(const i of this.actions)i.updateValue(this._progress)}}get progress(){return this._progress}init(){this.actions.forEach(e=>e.init())}}class lt{constructor(){o(this,"sequences",[]);o(this,"title","");o(this,"_progress",0);o(this,"direction",E.NONE);o(this,"state",f.START);o(this,"duration",1e3)}init(){this.sequences.forEach(e=>e.init())}addParallelAction(e){this.sequences.length==0&&this.sequences.push(new j(0,1)),this.sequences[this.sequences.length-1].actions.push(e)}addSequentialAction(e){const i=1/(this.sequences.length+1);let n=0;for(const h of this.sequences)h.updateStartEnd(n,n+i),n+=i;this.sequences.push(new j(1-i,1)),this.sequences[this.sequences.length-1].actions.push(e)}get progress(){return this._progress}set progress(e){e!=this._progress&&(this._progress=e,this.sequences.forEach(t=>t.progress=this._progress),this.updateState())}updateState(){this._progress==0?(this.state=f.START,this.direction==E.BACKWARD&&(this.direction=E.NONE)):this._progress==1?(this.state=f.END,this.direction==E.FORWARD&&(this.direction=E.NONE)):this.state=f.IN_PROGRESS}pause(){this.state==f.IN_PROGRESS&&(this.state=f.STOPPED)}unpause(){this.state==f.STOPPED&&(this.state=f.IN_PROGRESS)}togglePause(){this.state==f.IN_PROGRESS?this.pause():this.unpause()}run(){this.direction!=E.NONE&&(this.state=f.IN_PROGRESS)}forward(){this.state!=f.END&&(this.direction=E.FORWARD,this.state=f.IN_PROGRESS)}backward(){this.state!=f.START&&(this.direction=E.BACKWARD,this.state=f.IN_PROGRESS)}}class C{static easeLinear(e){return e}static easeInQuad(e){return e*e}static inverseEaseInQuad(e){return Math.sqrt(e)}static easeInCubic(e){return e*e*e}static inverseEaseInCubic(e){return Math.pow(e,1/3)}static getEasingByType(e){switch(e){case 0:return C.easeLinear;case 1:return C.easeInQuad;case 2:return C.easeInCubic;default:return C.easeLinear}}static getInverseEasingByType(e){switch(e){case 0:return C.easeLinear;case 1:return C.inverseEaseInQuad;case 2:return C.inverseEaseInCubic;default:return C.easeLinear}}}var Z=(r=>(r[r.LINEAR=0]="LINEAR",r[r.IN_QUAD=1]="IN_QUAD",r[r.IN_CUBIC=2]="IN_CUBIC",r))(Z||{});const P=class P{constructor(e,t,i){o(this,"title");o(this,"controls");o(this,"steps");o(this,"currentStep",new lt);o(this,"origin",d.zero());o(this,"cellSize",50);o(this,"offset",d.zero());o(this,"zoom",1);o(this,"selectedControls",[]);o(this,"_currentStepIndex",0);o(this,"_requestedStepProgress",0);o(this,"lastTime",0);o(this,"_width",100);o(this,"_height",100);o(this,"stepStartTime",0);o(this,"autoPlay",!1);o(this,"easingFunc",C.getEasingByType(Z.IN_QUAD));o(this,"inverseEasingFunc",C.getInverseEasingByType(Z.IN_QUAD));o(this,"onBeforeStepForwardCallback",()=>{});o(this,"onBeforeStepBackwardCallback",()=>{});o(this,"updateSubtitleCallback",()=>{});this.title=e,this.controls=t,this.steps=i,this.origin=d.zero()}get height(){return this._height}get width(){return this._width}updateWidthAndHeight(e,t){this._width=e,this._height=t,this.origin=new d(this._width/2,this._height/2),this.offset=new d(this._width/2,this._height/2)}get requestedStepProgress(){return this._requestedStepProgress}set requestedStepProgress(e){this._requestedStepProgress=e}get currentStepIndex(){return this._currentStepIndex}set currentStepIndex(e){this.steps.length>e&&(this._currentStepIndex=e,this.currentStep=this.steps[this._currentStepIndex])}applySelected(e){e.forEach(t=>{if(t.selected)this.selectedControls.push(t);else{const i=this.selectedControls.indexOf(t);i>=0&&this.selectedControls.splice(i,1)}})}deleteSelected(){this.controls=this.controls.filter(e=>!e.selected)}findControl(e){if(e.startsWith(P.SELECTED_PREFIX)){const t=parseInt(e.substring(P.SELECTED_PREFIX.length),10);return t<this.selectedControls.length?this.selectedControls[t]:void 0}else return this.controls.find(t=>t.id===e)}updateStartTime(){this.currentStep.direction==E.FORWARD?this.stepStartTime=this.lastTime-this.inverseEasingFunc(this.requestedStepProgress)*this.currentStep.duration:this.currentStep.direction===E.BACKWARD&&(this.stepStartTime=this.lastTime-(1-this.inverseEasingFunc(this.requestedStepProgress))*this.currentStep.duration)}updateRequestedProgressIfInMove(){this.currentStep.direction!=E.NONE&&this.currentStep.state!=f.STOPPED&&(this.currentStep.direction===E.FORWARD?this._requestedStepProgress=this.easingFunc((this.lastTime-this.stepStartTime)/this.currentStep.duration):this.currentStep.direction==E.BACKWARD&&(this._requestedStepProgress=this.easingFunc((this.currentStep.duration-(this.lastTime-this.stepStartTime))/this.currentStep.duration)),(this._requestedStepProgress<=.001||this._requestedStepProgress>1)&&(this._requestedStepProgress=this._requestedStepProgress<=.001?0:1))}updateProgress(){this.currentStep.progress!=this._requestedStepProgress&&(this.currentStep.progress=this._requestedStepProgress,this.autoPlay&&this.handleAutoPlay(),this.currentStep.state==f.START&&this._currentStepIndex==0&&this.updateSubtitleCallback(""))}handleAutoPlay(){this.currentStep.state==f.END&&this._currentStepIndex<this.steps.length-1?this.nextStep():this.currentStep.state==f.START&&this._currentStepIndex>0&&this.singleBackward()}togglePause(){this.updateStartTime(),this.currentStep.togglePause(),this.currentStep.state==f.STOPPED&&(this.autoPlay=!1)}singleForward(){this.currentStep.direction===E.FORWARD&&this.currentStep.state===f.IN_PROGRESS&&(this._requestedStepProgress=1),this.nextStep(),this.currentStep.forward(),this.updateStartTime(),this.currentStep.run()}singleBackward(){this.currentStep.direction===E.BACKWARD&&this.currentStep.state===f.IN_PROGRESS&&(this._requestedStepProgress=0),this.previousStep(),this.onBeforeStepBackwardCallback(this._currentStepIndex),this.currentStep.backward(),this.updateStartTime(),this.currentStep.run()}selectStep(e){this.currentStepIndex!==e&&(this.currentStepIndex=e)}previousStep(){this.currentStep.state==f.START&&this._currentStepIndex>0&&(this.selectStep(this._currentStepIndex-1),this._requestedStepProgress=1,this.updateSubtitleCallback(this.currentStep.title))}nextStep(){this.currentStep.state==f.END&&this._currentStepIndex<this.steps.length-1&&(this.selectStep(this._currentStepIndex+1),this.currentStep.init(),this._requestedStepProgress=0),this.onBeforeStepForwardCallback(this._currentStepIndex),this.currentStep.forward(),this.updateStartTime(),this.currentStep.run(),this.updateSubtitleCallback(this.currentStep.title)}};o(P,"SELECTED_PREFIX","selected");let U=P;class bt{constructor(e){o(this,"canvas");o(this,"ctx");o(this,"model",new U("",[],[]));o(this,"isDragging",!1);o(this,"initialPinchDistance",0);o(this,"lastZoom",this.model.zoom);o(this,"fps",1);o(this,"showDebug",!1);o(this,"showGrid",!1);o(this,"marginLeft",0);o(this,"marginTop",0);o(this,"EMPTY_TOOL","empty-tool");o(this,"DOT_TOOL","dot-tool");o(this,"BOX_TOOL","box-tool");o(this,"PAN_ZOOM_TOOL","pan-zoom-tool");o(this,"panZoomTool",new wt);o(this,"tools",new Map([[this.EMPTY_TOOL,new xt],[this.DOT_TOOL,new mt],[this.BOX_TOOL,new It],[this.PAN_ZOOM_TOOL,this.panZoomTool]]));o(this,"tool",this.panZoomTool);o(this,"pointerPosition",d.zero());o(this,"rect",d.zero());this.ctx=e.getContext("2d"),this.canvas=e,this.attachCanvasEventHandlers()}get requestedStepProgress(){return this.model.requestedStepProgress}set requestedStepProgress(e){this.model.requestedStepProgress=e}get zoom(){return this.model.zoom}set zoom(e){this.model.zoom=e}initModel(e){this.requestedStepProgress=0,this.model=e,this.model.currentStepIndex=0;for(let t of this.tools.values())t.updateModel(this)}apply(e){this.initModel(e),this.model.steps.length>0&&(this.model.selectStep(0),this.model.currentStep.init())}updatePositionAndSize(){const e=this.canvas.getBoundingClientRect();this.model.updateWidthAndHeight(e.width,e.height)}updatePointerPosition(e,t){this.pointerPosition.x=e-this.rect.x,this.pointerPosition.y=t-this.rect.y}attachCanvasEventHandlers(){/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||this.addCanvasEvent("mousedown",t=>{t.preventDefault(),t.stopPropagation(),this.updatePointerPosition(t.x,t.y),this.onPointerDown()}),this.addCanvasEvent("touchstart",t=>this.handleTouch(t,this.onPointerDown)),this.addCanvasEvent("mouseup",t=>this.onPointerUp()),this.addCanvasEvent("touchend",t=>this.handleTouch(t,this.onPointerUp)),this.addCanvasEvent("mousemove",t=>{t.preventDefault(),t.stopPropagation(),this.updatePointerPosition(t.x,t.y),this.onPointerMove()}),this.addCanvasEvent("touchmove",t=>this.handleTouch(t,this.onPointerMove)),this.addCanvasEvent("wheel",t=>this.handleScroll(t))}addCanvasEvent(e,t){this.canvas.addEventListener(e,t)}selectTool(e){this.tools.has(e)&&(this.tool=this.tools.get(e))}resetTool(){this.selectTool(this.PAN_ZOOM_TOOL)}fastForward(){this.model.autoPlay=!0,this.model.singleForward()}fastBackward(){this.model.autoPlay=!0,this.model.singleBackward()}forward(){this.model.autoPlay=!1,this.model.singleForward()}backward(){this.model.autoPlay=!1,this.model.singleBackward()}deleteSelected(){this.togglePause(),this.model.deleteSelected()}togglePause(){this.model.togglePause()}drawDebug(e){this.fps=1/((e-this.model.lastTime)/1e3);const t=this.model.width-210;this.drawText(`fps: ${Math.round(this.fps)} zoom: ${Math.round(this.model.zoom*100)/100} step: ${this.model.currentStepIndex} prog: ${Math.round(this.model.requestedStepProgress*100)/100}`,t,10,10,G)}draw(e){this.canvas.width=this.model.width,this.canvas.height=this.model.height,this.showDebug&&this.drawDebug(e),this.ctx.translate(this.model.origin.x,this.model.origin.y),this.ctx.scale(this.model.zoom,this.model.zoom),this.ctx.translate(-this.model.origin.x+this.model.offset.x,-this.model.origin.y+this.model.offset.y),this.model.updateRequestedProgressIfInMove(),this.model.updateProgress(),this.showGrid&&this.drawGrid();for(const t of this.model.controls)t.visible&&t.draw(this.ctx);this.model.lastTime=e,requestAnimationFrame(t=>this.draw(t))}drawText(e,t,i,n,h){this.ctx.font=`${n}px ${h}`,this.ctx.fillText(e,t,i)}drawGrid(){for(let h=-250;h<=250;h+=50)this.drawLine(h,-250,h,250),this.drawLine(-250,h,250,h)}drawLine(e,t,i,n){const h=this.ctx;h.strokeStyle="black",h.beginPath(),h.lineWidth=e==0||t==0?1:.4,h.moveTo(e,t),h.lineTo(i,n),h.stroke()}onPointerDown(){this.isDragging=!0;const e=new d(this.pointerPosition.x/this.model.zoom-this.model.offset.x+this.model.origin.x-this.model.origin.x/this.model.zoom,this.pointerPosition.y/this.model.zoom-this.model.offset.y+this.model.origin.y-this.model.origin.y/this.model.zoom);this.tool.click(e)}onPointerUp(){this.isDragging=!1,this.initialPinchDistance=0,this.lastZoom=this.model.zoom}onPointerMove(){this.isDragging&&this.tool.move(new d(this.pointerPosition.x/this.model.zoom+this.model.origin.x-this.model.origin.x/this.model.zoom,this.pointerPosition.y/this.model.zoom+this.model.origin.y-this.model.origin.y/this.model.zoom))}handleTouch(e,t){e.stopPropagation(),e.preventDefault(),e.touches.length==1?(this.updatePointerPosition(e.touches[0].clientX,e.touches[0].clientY),t.call(this)):e.type=="touchmove"&&e.touches.length>1&&(this.isDragging=!1,this.handlePinch(e))}handlePinch(e){const t={x:e.touches[0].clientX+window.scrollX-this.marginLeft,y:e.touches[0].clientY+window.scrollY-this.marginTop},i={x:e.touches[1].clientX+window.scrollX-this.marginLeft,y:e.touches[1].clientY+window.scrollY-this.marginTop},n=(t.x-i.x)**2+(t.y-i.y)**2;this.initialPinchDistance==0?this.initialPinchDistance=n:this.adjustZoom(null,n/this.initialPinchDistance)}handleScroll(e){e.preventDefault(),this.adjustZoom(e.deltaY*ft,1)}adjustZoom(e,t){this.isDragging||(e?this.model.zoom-=e:t&&(this.model.zoom=t*this.lastZoom),this.model.zoom=Math.min(this.model.zoom,ut),this.model.zoom=Math.max(this.model.zoom,pt))}}var s=(r=>(r.MINUS="-",r.PLUS="+",r.COMMA=",",r.COLON=":",r.EQUALS="=",r.LEFT_BRACKET="(",r.RIGHT_BRACKET=")",r.LEFT_SQUARE_BRACKET="[",r.RIGHT_SQUARE_BRACKET="]",r.LESS_THAN="<",r.ASTERIX="*",r.GREATER_THAN=">",r.ASSIGN="<-",r.CLONE="*->",r.SWAP="<->",r.MOVE="->",r.IDENTIFIER="IDENTIFIER",r.NUMBER="NUMBER",r.STRING="STRING",r.TRUE="true",r.FALSE="false",r.ID="id",r.TITLE="title",r.TEXT="text",r.DOT="dot",r.DOTS="dots",r.BOXES="boxes",r.AT="at",r.SIZE="size",r.SPAN="span",r.FONT_SIZE="fontSize",r.END="end",r.WIDTH="width",r.COLOR="color",r.COLORS="colors",r.IDS="ids",r.BOX="box",r.LINE="line",r.STEP="step",r.DURATION="duration",r.SELECTED="selected",r.VISIBLE="visible",r.LAYOUT="layout",r))(s||{});class Ct{constructor(e,t,i){o(this,"position");o(this,"type");o(this,"value");this.position=e,this.type=t,this.value=i||""}}class B{static isKeyword(e){return this.KEYWORDS_MAP.has(e)}static getKeywordByName(e){return this.KEYWORDS_MAP.get(e)}}o(B,"KEYWORDS_MAP",new Map([[s.ID.toString(),s.ID],[s.TRUE.toString(),s.TRUE],[s.FALSE.toString(),s.FALSE],[s.DOT.toString(),s.DOT],[s.DOTS.toString(),s.DOTS],[s.BOXES.toString(),s.BOXES],[s.TITLE.toString(),s.TITLE],[s.TEXT.toString(),s.TEXT],[s.BOX.toString(),s.BOX],[s.LINE.toString(),s.LINE],[s.AT.toString(),s.AT],[s.END.toString(),s.END],[s.SIZE.toString(),s.SIZE],[s.SPAN.toString(),s.SPAN],[s.FONT_SIZE.toString(),s.FONT_SIZE],[s.WIDTH.toString(),s.WIDTH],[s.COLOR.toString(),s.COLOR],[s.COLORS.toString(),s.COLORS],[s.IDS.toString(),s.IDS],[s.STEP.toString(),s.STEP],[s.DURATION.toString(),s.DURATION],[s.SELECTED.toString(),s.SELECTED],[s.VISIBLE.toString(),s.VISIBLE],[s.LAYOUT.toString(),s.LAYOUT]])),o(B,"ASSIGN_PROPERTIES",[s.SELECTED,s.TEXT,s.COLOR,s.VISIBLE,s.STRING]);class _t{constructor(){o(this,"start",0);o(this,"position",0);o(this,"line",1);o(this,"tokens",[]);o(this,"source","")}scan(e){for(this.source=e;this.position<e.length;){const t=this.advance();switch(t){case" ":case"\r":break;case`
`:this.line++;break;case"	":break;case"(":this.addToken(s.LEFT_BRACKET);break;case")":this.addToken(s.RIGHT_BRACKET);break;case"[":this.addToken(s.LEFT_SQUARE_BRACKET);break;case"]":this.addToken(s.RIGHT_SQUARE_BRACKET);break;case":":this.addToken(s.COLON);break;case",":this.addToken(s.COMMA);break;case"<":this.matchSwap()||this.addToken(s.LESS_THAN);break;case"*":this.matchClone()||this.addToken(s.ASTERIX);break;case"+":this.addToken(s.PLUS);break;case"-":this.match(">")?this.addToken(s.MOVE):this.addToken(s.MINUS);break;case"=":this.addToken(s.EQUALS);break;case">":this.addToken(s.GREATER_THAN);break;case"/":if(this.match("/"))for(;this.peek()!=`
`&&!this.isAtEnd();)this.advance();break;case"'":this.string();break;default:if(this.isDigit(t))this.number();else if(this.isAlpha(t))this.identifier();else throw new Error(`line: ${this.line} Unexpected character ${t} charcode: ${t.charCodeAt(0)}`)}this.start=this.position}return this.tokens}matchSwap(){return this.match("-")?this.match(">")?(this.addToken(s.SWAP),!0):(this.addToken(s.ASSIGN),!0):!1}matchClone(){return this.match("-")&&this.match(">")?(this.addToken(s.CLONE),!0):!1}addToken(e){this.addTokenValue(e)}addTokenValue(e,t){this.tokens.push(new Ct(this.start,e,t))}advance(){return this.source.charAt(this.position++)}isAtEnd(){return this.position>=this.source.length}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.position)}match(e){return this.isAtEnd()||this.source.charAt(this.position)!=e?!1:(this.position++,!0)}isDigit(e){return e>="0"&&e<="9"}isDigitOrDot(e){return this.isDigit(e)||e=="."}number(){for(;this.isDigitOrDot(this.peek());)this.advance();let e=this.source.substring(this.start,this.position);this.addTokenValue(s.NUMBER,e)}isAlpha(e){return/[\p{Letter}\p{Mark}]+/gu.test(e)||e=="_"}isAlphanumeric(e){return this.isAlpha(e)||this.isDigit(e)}string(){for(;this.peek()!="'"&&!this.isAtEnd();)this.peek()==`
`&&this.line++,this.advance();if(this.isAtEnd())throw new Error(`line: ${this.line} Unterminated String`);this.advance();let e=this.source.substring(this.start+1,this.position-1);this.addTokenValue(s.STRING,e)}identifier(){for(;this.isAlphanumeric(this.peek());)this.advance();let e=this.source.substring(this.start,this.position);const t=B.isKeyword(e)?B.getKeywordByName(e):s.IDENTIFIER;this.addTokenValue(t,e)}}class D{constructor(e){o(this,"model");this.model=e}init(){}onBeforeForward(){}onAfterBackward(){}}class kt extends D{constructor(t,i,n,h=""){super(t);o(this,"start");o(this,"to");o(this,"end");o(this,"left",_);o(this,"right",_);o(this,"leftId");o(this,"rightId","");this.start=d.zero(),this.to=n,this.end=n,this.leftId=i,this.rightId=h}init(){super.init(),this.selectControls()}selectControls(){const t=this.model.findControl(this.leftId);if(t?(this.left=t,this.start=this.left.position.clone(),this.end=this.calculateEnd(this.start,this.to)):this.left=_,this.rightId!==""){const i=this.model.findControl(this.rightId);i&&(this.right=i,this.end=this.right.position.clone())}}onBeforeForward(){super.onBeforeForward(),this.selectControls()}calculateEnd(t,i){return i.sign==x.NONE?new d(i.x,i.y):i.sign==x.PLUS?new d(t.x+i.x,t.y+i.y):new d(t.x-i.x,t.y-i.y)}updateValue(t){t==0?this.left.updatePosition(this.start.x,this.start.y):t==1?this.left.updatePosition(this.end.x,this.end.y):this.left.updatePosition(this.start.x+(this.end.x-this.start.x)*t,this.start.y+(this.end.y-this.start.y)*t)}}class At extends D{constructor(t,i,n){super(t);o(this,"left",_);o(this,"right",_);o(this,"start");o(this,"end");o(this,"leftControlId");o(this,"rightControlId");this.start=d.zero(),this.end=d.zero(),this.leftControlId=i,this.rightControlId=n}init(){super.init(),this.selectControls()}onBeforeForward(){super.onBeforeForward(),this.selectControls()}selectControls(){const t=this.model.findControl(this.leftControlId);this.left=t||_;const i=this.model.findControl(this.rightControlId);this.right=i||_,this.start=this.left.position.clone(),this.end=this.right.position.clone()}updateValue(t){if(t==0)this.left.updatePosition(this.start.x,this.start.y),this.right.updatePosition(this.end.x,this.end.y);else if(t==1)this.left.updatePosition(this.end.x,this.end.y),this.right.updatePosition(this.start.x,this.start.y);else{const i=(this.end.x-this.start.x)*t,n=(this.end.y-this.start.y)*t;this.left.updatePosition(this.start.x+i,this.start.y+n),this.right.updatePosition(this.end.x-i,this.end.y-n)}}}class yt extends D{constructor(t,i,n){super(t);o(this,"left",_);o(this,"right",_);o(this,"leftControlId");o(this,"rightControlId");o(this,"isAdded");this.isAdded=!1,this.leftControlId=i,this.rightControlId=n}init(){super.init();const t=this.model.findControl(this.leftControlId);t?(this.left=t,this.cloneAndAddControl()):this.left=_}cloneAndAddControl(){this.isAdded||(this.right=this.left.clone(),this.right.id=this.rightControlId,this.model.controls.push(this.right),this.isAdded=!0)}onBeforeForward(){super.onBeforeForward(),this.cloneAndAddControl()}onAfterBackward(){super.onAfterBackward(),this.destroyControls()}destroyControls(){if(this.isAdded){const t=this.model.controls.indexOf(this.right);t>-1&&(this.model.controls.splice(t,1),this.isAdded=!1)}}updateValue(t){}}class K{constructor(e,t){o(this,"controlId");o(this,"propertyChanges");this.controlId=e,this.propertyChanges=t}}class Tt{constructor(e,t,i){o(this,"property");o(this,"newValue");o(this,"oldValue");this.property=e,this.newValue=t,this.oldValue=i}}class vt extends D{constructor(t,i,n){super(t);o(this,"control",_);o(this,"controlId");o(this,"properties");o(this,"change");o(this,"applied",!1);this.controlId=i,this.change=new K(this.controlId,[]),this.properties=n}init(){super.init(),this.selectControls()}selectControls(){this.control=this.model.findControl(this.controlId)}onBeforeForward(){super.onBeforeForward(),this.selectControls(),this.applyChanges()}onAfterBackward(){super.onAfterBackward(),this.revertChanges()}applyChanges(){if(!this.applied&&this.control){this.applied=!0;let t=this.control,i=[];for(const n of this.properties.keys()){const h=t[n],l=this.properties.get(n);t[n]=l,i.push(new Tt(n,l,h)),n==="selected"&&this.model.applySelected([this.control])}this.change=new K(this.controlId,i)}}revertChanges(){if(this.applied&&this.control){this.applied=!1;let t=this.control;for(const i of this.change.propertyChanges)t[i.property]=i.oldValue;this.change=new K(this.controlId,[])}}updateValue(t){}}class Ot extends D{constructor(t,i){super(t);o(this,"start",d.zero());o(this,"to",d.zero());this.to=i}onBeforeForward(){super.onBeforeForward(),this.start=this.model.offset.clone()}init(){super.init()}updateValue(t){this.model.offset.x=this.start.x-this.to.x*t,this.model.offset.y=this.start.y-this.to.y*t}}const $=class $ extends N{constructor(t,i,n,h,l,a,c){super();o(this,"color");o(this,"_end");o(this,"width");o(this,"selected");o(this,"visible");o(this,"distance",d.zero());this.id=t,this.position=i,this._end=n,this.distance=this._end.minus(this.position),this.width=h,this.color=l,this.selected=c,this.visible=a}get end(){return this._end}set end(t){this.distance=this.position.minus(this.end),this._end=t}draw(t){t.strokeStyle=this.color,this.selected&&(t.strokeStyle=Y),t.beginPath(),t.lineWidth=this.width,t.lineCap="round",t.moveTo(this.position.x,this.position.y),t.lineTo(this._end.x,this._end.y),t.stroke()}hitTest(t){return!1}clone(){return new $(this.id.toString(),this.position.clone(),this.end.clone(),this.width,this.color.toString(),this.visible,this.selected)}updatePosition(t,i){this.position.x=t,this.position.y=i,this._end.x=t+this.distance.x,this._end.y=i+this.distance.y}};o($,"counter",1);let V=$;var w=(r=>(r.COL="COL",r.ROW="ROW",r.TREE="TREE",r))(w||{});class W{constructor(){o(this,"scanner",new _t);o(this,"model",W.newModel());o(this,"position",0);o(this,"tokens",[]);o(this,"cellSize",50);o(this,"identifiesCounter",new Map)}static newModel(){return new U("",[],[])}eof(){return this.tokens.length<=this.position}advance(){return this.tokens[this.position++]}peek(){return this.tokens[this.position]}parse(e){for(this.model=W.newModel(),this.tokens=this.scanner.scan(e);this.position<this.tokens.length;)switch(this.advance().type){case s.TITLE:this.title();break;case s.BOX:this.box();break;case s.DOT:this.dot();break;case s.LINE:this.line();break;case s.DOTS:this.dots();break;case s.BOXES:this.boxes();break;case s.STEP:this.step();break}return this.model}calculateLayoutPosition(e,t,i,n){let h=t.clone();switch(e){case w.COL:h.x+=i*n;break;case w.ROW:h.y+=i*n;break;case w.TREE:throw new Error(`Unsupported layout TREE at ${this.peek().position}`)}return h}boxes(){const e=[s.SIZE,s.AT,s.IDS,s.LAYOUT,s.SPAN,s.COLORS];let t=new d(this.cellSize,this.cellSize),i=new d(0,0),n="",h="",l=[],a=[],c=0,p=w.COL;for(;!this.eof()&&e.includes(this.peek().type);)switch(this.advance().type){case s.ID:h=this.propertyControlId();break;case s.AT:i=this.at();break;case s.SIZE:t=this.sizePoint();break;case s.SPAN:c=this.size();break;case s.IDS:l=this.ids();break;case s.COLORS:a=this.colors();break;case s.LAYOUT:p=this.layout();break}if(l.length==0)throw new Error(`ids attribute is mandatory for boxes at ${this.peek().position}`);i.unit==m.CELL&&this.normalizePointUnit(i),a=a.length>0?a:k;let u=t.x+this.cellSize*c,g=0;for(h of l){let I=this.calculateLayoutPosition(p,i,g,u),b=a[g%a.length];const v=this.getId(h!=""?h:n),S=new L(v,I,t,F,b,h,!0,!1);this.model.controls.push(S),S.selected&&this.model.selectedControls.push(S),g++}}getId(e){if(this.identifiesCounter.has(e.trim())){let t=this.identifiesCounter.get(e)+1;return this.identifiesCounter.set(e,t),t+"_"+e}else return this.identifiesCounter.set(e,0),e}box(){const e=[s.ID,s.SIZE,s.AT,s.TEXT,s.COLOR,s.VISIBLE,s.SELECTED,s.FONT_SIZE];let t=new d(this.cellSize,this.cellSize),i=new d(0,0),n="",h=null,l=k[this.model.controls.length%k.length],a=!0,c=!1,p=F;for(;!this.eof()&&e.includes(this.peek().type);)switch(this.advance().type){case s.ID:h=this.propertyControlId();break;case s.TEXT:n=this.text();break;case s.AT:i=this.at();break;case s.SIZE:t=this.sizePoint();break;case s.COLOR:l=this.color();break;case s.VISIBLE:a=this.visible();break;case s.SELECTED:c=this.selected();break;case s.FONT_SIZE:p=this.fontSize();break}h==null&&(h="b"+this.model.controls.length),i.unit==m.CELL&&this.normalizePointUnit(i);const u=this.getId(h!=""?h:n),g=new L(u,i,t,p,l,n,a,c);this.model.controls.push(g),g.selected&&this.model.selectedControls.push(g)}normalizePointUnit(e){e.unit==m.CELL&&(e.x=e.x*this.cellSize,e.y=e.y*this.cellSize,e.unit=m.PIXEL)}line(){const e=[s.ID,s.END,s.AT,s.WIDTH,s.COLOR,s.VISIBLE,s.SELECTED];let t=new d(100,100),i=new d(0,0),n=1,h=null,l=O,a=!0,c=!1;for(;!this.eof()&&e.includes(this.peek().type);)switch(this.advance().type){case s.ID:h=this.propertyControlId();break;case s.AT:i=this.at(),this.normalizePointUnit(i);break;case s.END:t=this.end(),this.normalizePointUnit(t);break;case s.WIDTH:n=this.width();break;case s.COLOR:l=this.color();break;case s.VISIBLE:a=this.visible();break;case s.SELECTED:c=this.selected();break}h==null&&(h="l"+this.model.controls.length);const p=this.getId(h),u=new V(p,i,t,n,l,a,c);this.model.controls.push(u),u.selected&&this.model.selectedControls.push(u)}dots(){const e=[s.SIZE,s.AT,s.IDS,s.LAYOUT,s.SPAN,s.COLORS];let t=20,i=new d(0,0),n="",h="",l=[],a=[],c=0,p=w.COL;for(;!this.eof()&&e.includes(this.peek().type);)switch(this.advance().type){case s.ID:h=this.propertyControlId();break;case s.AT:i=this.at();break;case s.SIZE:t=this.size();break;case s.SPAN:c=this.size();break;case s.IDS:l=this.ids();break;case s.COLORS:a=this.colors();break;case s.LAYOUT:p=this.layout();break}if(l.length==0)throw new Error(`ids attribute is mandatory for dots at ${this.peek().position}`);i.unit==m.CELL&&this.normalizeDotPosition(i),a=a.length>0?a:k;let u=0,g=this.cellSize+c*this.cellSize;for(h of l){const I=this.getId(h!=""?h:n);let b=this.calculateLayoutPosition(p,i,u,g),v=a[u%a.length];const S=new R(I,b,t,v,h,!0,!1);this.model.controls.push(S),S.selected&&this.model.selectedControls.push(S),u++}}dot(){const e=[s.ID,s.SIZE,s.AT,s.TEXT,s.COLOR,s.VISIBLE,s.SELECTED];let t=20,i=new d(0,0),n=null,h="",l=k[this.model.controls.length%k.length],a=!0,c=!1;for(;!this.eof()&&e.includes(this.peek().type);)switch(this.advance().type){case s.ID:h=this.propertyControlId();break;case s.TEXT:n=this.text();break;case s.COLOR:l=this.color();break;case s.AT:i=this.at();break;case s.SIZE:t=this.size();break;case s.VISIBLE:a=this.visible();break;case s.SELECTED:c=this.selected();break}h===""&&n===""&&(h="d"+this.model.controls.length),n==null&&(n=h),i.unit==m.CELL&&this.normalizeDotPosition(i);const p=this.getId(h!=""?h:n),u=new R(p,i,t,l,n,a,c);this.model.controls.push(u),u.selected&&this.model.selectedControls.push(u)}normalizeDotPosition(e){e.unit==m.CELL&&(e.x=e.x*this.cellSize+this.cellSize/2,e.y=e.y*this.cellSize+this.cellSize/2,e.unit=m.PIXEL)}text(){if(this.expectColon(),this.peek().type==s.STRING)return this.advance().value;let e="";for(;this.peek().type==s.IDENTIFIER;){const t=this.advance();e+=" "+t.value.toString()}return e.trim()}fontSize(){return this.expectColon(),this.number()}color(){return this.expectColon(),this.colorValue()}colors(){this.expectColon();let e=[];for(;!this.eof()&&this.canBeColor(this.peek().type);)e.push(this.colorValue());return e}colorValue(){let e="";if(this.peek().type==s.IDENTIFIER){let t=this.advance();if(e+=t.value,this.match(s.LEFT_BRACKET)){for(e+="(",e+=this.number().toString();this.match(s.COMMA);)e+=",",e+=this.number().toString();if(this.match(s.RIGHT_BRACKET))e+=")";else throw new Error(`Expected closing bracket at ${this.peek().position} got token ${this.peek().value} instead`)}}return e}at(){return this.expectColon(),this.point()}end(){return this.expectColon(),this.point()}size(){return this.expectColon(),this.number()}layout(){if(this.expectColon(),this.eof())throw new Error("Expected proper layout got eof");let e=this.advance();switch(`${e.value.toString().toUpperCase()}`){case w.COL:return w.COL;case w.ROW:return w.ROW;case w.TREE:return w.TREE;default:throw new Error(`Expected proper layout at ${e.position} got ${e.value}  instead`)}}sizePoint(){this.expectColon();const e=this.point();return e.unit==m.CELL&&(e.x=e.x*this.cellSize,e.y=e.y*this.cellSize,e.unit=m.PIXEL),e}width(){return this.expectColon(),this.number()}expectColon(){if(!this.match(s.COLON))throw new Error(`Expected colon at ${this.position} got ${this.peek().value} instead`)}number(){let e,t=this.peek();if(e=t.type==s.MINUS,e&&this.advance(),t=this.advance(),t.type==s.NUMBER){let i=t.value.includes(".")?parseFloat(t.value):parseInt(t.value,10);return e?-i:i}else throw new Error(`Expected number at position: ${t.position} got token ${t.value} instead`)}title(){this.model.title=this.text()}duration(){this.expectColon();let e=this.number();const t=this.peek();return t.type==s.IDENTIFIER&&t.value=="s"?(e*=1e3,this.advance()):t.type==s.IDENTIFIER&&t.value=="ms"&&this.advance(),e}step(){this.expectColon();let e=new lt;this.peek().type===s.STRING&&(e.title=this.peek().value,this.advance()),this.match(s.DURATION)&&(e.duration=this.duration());let t=this.action(),i=!0;for(;t!=null;){if(i?e.addParallelAction(t):e.addSequentialAction(t),this.eof()||this.peek().type==s.STEP){e.sequences.length>0&&this.model.steps.push(e);return}i=this.match(s.COMMA),t=this.action()}}action(){if(this.eof())return null;let e=this.controlId(),t=this.peek();switch(t.type){case s.ASSIGN:return this.assign(e);case s.MOVE:return this.move(e);case s.SWAP:return this.swap(e);case s.CLONE:if(this.advance(),t=this.peek(),t.type==s.IDENTIFIER)return this.advance(),new yt(this.model,e,t.value);break}return null}propertyControlId(){return this.expectColon(),this.controlId()}controlId(){let e=this.advance();if(this.canBeId(e.type)){let t="";return e.type==s.NUMBER&&!this.eof()&&this.peek().value.startsWith("_")&&(t=e.value,e=this.advance()),t+e.value}else throw new Error(`Expected control identifier at ${e.position} got ${e.value} instead`)}canBeId(e){return e==s.IDENTIFIER||e==s.STRING||e==s.NUMBER}canBeColor(e){return e==s.IDENTIFIER||e==s.STRING}ids(){this.expectColon();let e=[];for(;!this.eof()&&this.canBeId(this.peek().type);)e.push(this.controlId());return e}move(e){this.advance();let t=d.zero(),i="";if(this.pointInBracketsAhead()?(t=this.point(),this.normalizePointUnit(t)):(i=this.peek().value,this.advance()),e=="camera"){if(t.sign==x.NONE)throw new Error("Only relative move for camera is currently supported");return new Ot(this.model,t)}return new kt(this.model,e,t,i)}pointInBracketsAhead(){const e=this.peek();return e.type==s.PLUS||e.type==s.MINUS||e.type==s.LEFT_BRACKET}assign(e){this.advance();let t=this.peek(),i=new Map;for(;!this.eof()&&B.ASSIGN_PROPERTIES.includes(t.type);){let n="",h=t.type;h==s.STRING?n="text":(this.advance(),n=t.type.toString());const l=this.peek();let a;h==s.COLOR?a=this.color():h===s.SELECTED||h===s.VISIBLE?(this.expectColon(),a=this.boolean(),this.advance()):(a=l.value,this.advance()),i.set(n,a),t=this.peek()}return new vt(this.model,e,i)}visible(){return this.expectColon(),this.boolean()}selected(){return this.expectColon(),this.boolean()}boolean(){const e=this.peek();switch(e.type){case s.TRUE:return!0;case s.FALSE:return!1;default:throw new Error(`Expected boolean value: ${e.position} got token ${e.value} instead`)}}swap(e){this.advance();const i=this.peek().value;return this.advance(),new At(this.model,e,i)}plus(){return this.match(s.PLUS)}minus(){return this.match(s.MINUS)}sign(){let e=x.NONE;return this.plus()&&(e=x.PLUS),this.minus()&&(e=x.MINUS),e}point(){let e=this.sign(),t=m.PIXEL,i=this.match(s.LEFT_BRACKET),n=!1;!i&&this.match(s.LEFT_SQUARE_BRACKET)&&(n=!0,t=m.CELL);const h=i||n;let l=this.number();!h&&e!==x.NONE&&(l=-l,e=x.NONE);let a=this.advance();if(a.type!=s.COMMA)throw new Error(`Expected comma at position: ${a.position} got token ${a} instead`);let c=this.number();if(i&&!this.match(s.RIGHT_BRACKET))throw new Error(`Expected right bracket at position: ${a.position} got token ${a} instead`);if(n&&!this.match(s.RIGHT_SQUARE_BRACKET))throw new Error(`Expected right square bracket at position: ${a.position} got token ${a} instead`);return new d(l,c,e,t)}match(e){return this.eof()||this.peek().type!=e?!1:(this.position++,!0)}}const J="style",tt="color",et="border",st="code",Lt="width",Pt="height",it="debug",z="experimental",ot="controls",nt="autoplay",rt="keyboard",ht="grid",Rt="initialized",T=class T extends HTMLElement{constructor(){super(...arguments);o(this,"dotAndBox");o(this,"_code","");o(this,"color","white");o(this,"debug",!1);o(this,"grid",!1);o(this,"border","1px solid #ccc");o(this,"defaultWidth",100);o(this,"defaultHeight",100);o(this,"showControls",!1);o(this,"extendedMenu",!1);o(this,"experimental",!1);o(this,"autoplay",!1);o(this,"canvas");o(this,"keyboard",!1);o(this,"_initialized",!1);o(this,"_wrapper",null);o(this,"keyboardHandlerLambda",t=>this.handleKeyDown(t))}get initialized(){return this._initialized}get code(){return this._code}set code(t){this._code=t,this.reset()}reset(){this._code&&this.dotAndBox&&(this.updateCanvasStyle(this.canvas),this.applyCode(),this.dotAndBox.showDebug=this.debug,this.dotAndBox.showGrid=this.grid,this.dotAndBox.updatePositionAndSize(),this.dotAndBox.draw(0))}applyCode(){const t=new W().parse(this._code);t.onBeforeStepForwardCallback=i=>this.dispatchOnBeforeStepForward(i),t.onBeforeStepBackwardCallback=i=>this.dispatchOnBeforeStepBackward(i),t.updateSubtitleCallback=i=>this.updateSubtitle(i),this.updateTitle(t.title),this.dotAndBox.apply(t)}connectedCallback(){const t=this.attachShadow({mode:"open"});t.innerHTML=`
      <style>
      :host { display: block; padding: 0;border: ${this.border};}      
      
      #title-wrapper {
        margin-top: 5px;
        margin-left: 5px;
        margin-right: 5px;
        position: absolute;  
        color: rgba(55,55,55);      
      }
      
      #title {
        font-size: 20px;
        font-weight: bold;
        font-family: Verdana, Geneva, sans-serif
      }
      
      #subtitle {     
        font-size: 18px;      
        font-family: Verdana, Geneva, sans-serif;
      }    
      
      #controls-menu {    
        position: relative;   
        height: 50px;
        left: 0;       
        top: -54px;
        overflow: hidden;
        background-color: transparent;
        display: ${this.showControls?"flex":"none"};
        flex-wrap: nowrap;
        align-items: center;
        justify-content: center;
      }               
      
      #controls-menu-extended {    
        position: relative;   
        height: 50px;
        left: 0;
        padding-left: 10px;
        padding-right: 10px;
        top: -154px;
        overflow: hidden;
        background-color: transparent;          
        display: none;
        flex-wrap: nowrap;
        align-items: center;
        justify-content: center;
      }
            
      #controls-menu button, #controls-menu-extended  button {
        color:  rgba(23,23,23,0.7);
        background-color: white;
        font-size: 22px;                 
        width: 36px;
        height: 36px;
        margin-left: 3px;
        margin-right: 3px;
        padding: 0;
        border-radius: 50%;
        border: solid 1px gray;
      }
            
      #controls-menu button:hover  {
        color:  #2d2828;      
        border: solid 1px #2d2828;
      }
      
      .button-icon {
        fill: rgba(23,23,23,0.7);       
      }
      
      button:hover .button-icon {
        fill: black;
        stroke: black;
      }
      
      </style>
      <div id="wrapper">
       <div id="title-wrapper">
         <div id="title"></div>
         <div id="subtitle"></div>
       </div>              
       <canvas id="canvas"></canvas>         
       <div id="controls-menu"></div>
       <div id="controls-menu-extended"></div>
      </div>
    `,this.buildControls(t),this.canvas=this.getCanvas(t),this.dotAndBox=new bt(this.canvas),this.reset(),this._initialized=!0,this._wrapper=this.shadowRoot.getElementById("wrapper"),this._wrapper.dispatchEvent(new CustomEvent(Rt,{bubbles:!0,cancelable:!1,composed:!0})),this.autoplay&&this.fastForward(),this.onpointerdown=i=>{i.stopPropagation();const n=this.getBoundingClientRect();this.dotAndBox.rect=new d(n.x,n.y)}}getCanvas(t){return t.getElementById("canvas")}updateCanvasStyle(t){t.width=this.offsetWidth?this.offsetWidth-2:this.defaultWidth,t.height=this.offsetHeight?this.offsetHeight-2:this.defaultHeight,t.style.background=this.color,t.style.padding="0",t.style.margin="0",t.style.overflow="hidden",t.style.userSelect="none"}updateTitle(t){const i=this.shadowRoot.getElementById("title");i.style.width=`${this.offsetWidth?this.offsetWidth-2:this.defaultWidth}px`,i.innerText=t}updateSubtitle(t){const i=this.shadowRoot.getElementById("subtitle");i.style.width=`${this.offsetWidth?this.offsetWidth-2:this.defaultWidth}px`,i.innerText=t}updateControls(){const t=this.shadowRoot.getElementById("controls-menu");t.style.display=this.showControls?"flex":"none";const i=this.shadowRoot.getElementById(z);i.style.display=this.experimental?"flex":"none"}dispatchOnBeforeStepForward(t){const i=new CustomEvent(T.ON_BEFORE_STEP_FORWARD,{bubbles:!0,composed:!0,detail:{step:t}});this._wrapper.dispatchEvent(i)}dispatchOnBeforeStepBackward(t){const i=new CustomEvent(T.ON_BEFORE_STEP_BACKWARD,{bubbles:!0,composed:!0,detail:{step:t}});this._wrapper.dispatchEvent(i)}buildControls(t){const i=t.getElementById("controls-menu"),n=t.getElementById("controls-menu-extended"),h=document.createElement("button");h.onclick=S=>this.backward(),h.innerHTML=` 
          <svg class="button-icon" viewBox="0 0 36 36">
            <path d="M 9 17 L 24 10 L 24 24 Z"/>           
        </svg>
             `,i.append(h);const l=document.createElement("button");l.onclick=S=>this.dotAndBox.togglePause(),l.innerHTML=` 
         <svg class="button-icon" viewBox="0 0 36 36">
          <rect x="11" y="11" width="14" height="14" />
         </svg>`,i.append(l);const a=document.createElement("button");a.onclick=S=>this.forward(),a.innerHTML=` 
        <svg class="button-icon" viewBox="0 0 36 36">       
           <path d="M 12 10 L 27 17 L 12 24 Z"/>           
        </svg>`,i.append(a);const c=document.createElement("button");c.onclick=S=>this.reset(),c.innerHTML=` 
        <svg class="button-icon" stroke="rgba(23,23,23,0.7)" viewBox="0 0 36 36">
           <path d="M 22 11 L 22 17" stroke-width="2" stroke-linecap="round"/>        
           <path d="M 22 11 L 27 11" stroke-width="2" stroke-linecap="round"/>                   
           <path d="M 23 12 A 8 8 0 1 1 13 12" stroke-width="2" fill="transparent" />
        </svg>`,i.append(c);const p=document.createElement("button");p.onclick=S=>this.toggleExtendedMenu(),p.innerHTML=` 
        <svg class="button-icon" stroke="rgba(23,23,23,0.7)" viewBox="0 0 36 36">
           <circle cx="10" cy="18" r="1"  />
           <circle cx="18" cy="18" r="1"  />
           <circle cx="26" cy="18" r="1"  />
        </svg>`,i.append(p);const u=document.createElement("input");u.id="progress-range",u.type="range",u.min="0",u.max="1",u.step="0.01",u.value="0",u.style.height="100%",u.style.width="100%",u.oninput=S=>{this.dotAndBox.requestedStepProgress=parseFloat(S.target.value)},n.append(u);const g=document.createElement("div");g.id=z,g.style.display=this.experimental?"flex":"none";const I=document.createElement("button");I.onclick=S=>this.dotAndBox.selectTool(this.dotAndBox.DOT_TOOL),I.innerHTML=` 
        <svg class="button-icon" stroke="rgba(23,23,23,0.7)" viewBox="0 0 36 36">
            <circle cx="18" cy="18" r="8" stroke-width="2" fill="transparent"   />
        </svg>`,g.append(I);const b=document.createElement("button");b.onclick=S=>this.dotAndBox.selectTool(this.dotAndBox.BOX_TOOL),b.innerHTML=` 
        <svg class="button-icon" stroke="rgba(23,23,23,0.7)" viewBox="0 0 36 36">
            <rect x="11" y="11" width="14" height="14" stroke-width="2" fill="transparent" />
        </svg>`,g.append(b);const v=document.createElement("button");v.onclick=S=>console.log(this.dotAndBox.model),v.append("ⅈ"),g.append(v),n.append(g)}toggleExtendedMenu(){this.extendedMenu?this.hideExtendedMenu():this.showExtendedMenu()}hideExtendedMenu(){if(this.extendedMenu){const t=this.shadowRoot.getElementById("controls-menu-extended");this.extendedMenu=!1,t.style.display="none"}}showExtendedMenu(){if(!this.extendedMenu){const t=this.shadowRoot.getElementById("controls-menu-extended"),i=this.shadowRoot.getElementById("progress-range");i.value=`${this.dotAndBox.requestedStepProgress}`,this.extendedMenu=!0,t.style.display="flex"}}updateKeyboardHandler(){this.keyboard?document.addEventListener("keydown",this.keyboardHandlerLambda):document.removeEventListener("keydown",this.keyboardHandlerLambda)}handleKeyDown(t){t.key==="ArrowLeft"?this.dotAndBox.backward():t.key==="ArrowRight"?this.dotAndBox.forward():t.key==="Delete"&&this.dotAndBox.deleteSelected()}forward(){this.hideExtendedMenu(),this.dotAndBox.forward()}fastForward(){this.dotAndBox.fastForward()}backward(){this.hideExtendedMenu(),this.dotAndBox.backward()}fastBackward(){this.dotAndBox.fastBackward()}resize(){this.canvas&&(this.updateCanvasStyle(this.canvas),this.dotAndBox.updatePositionAndSize())}disconnectedCallback(){console.log("Custom element removed from page.")}adoptedCallback(){console.log("Custom element moved to new page.")}attributeChangedCallback(t,i,n){switch(t){case J:this.resize();break;case st:this._code=n.trim(),this.dotAndBox&&this.applyCode();break;case tt:this.color=n;break;case et:this.border=n;break;case ot:this.showControls=n!=null,this.dotAndBox&&this.updateControls();break;case z:this.experimental=n!=null,this.dotAndBox&&this.updateControls();break;case rt:this.keyboard=n!=null,this.updateKeyboardHandler();break;case nt:this.autoplay=n!=null,this.dotAndBox&&this.fastForward();break;case it:this.debug=n!=null,this.dotAndBox&&(this.dotAndBox.showDebug=this.debug);break;case ht:this.grid=n!=null,this.dotAndBox&&(this.dotAndBox.showGrid=this.grid);break;default:console.log(t,i,n)}}};o(T,"ELEM_NAME","dot-and-box"),o(T,"ON_BEFORE_STEP_FORWARD","on_before_step_forward"),o(T,"ON_BEFORE_STEP_BACKWARD","on_before_step_backward"),o(T,"observedAttributes",[J,tt,et,st,Lt,Pt,it,z,ot,nt,rt,ht]);let q=T;customElements.define(q.ELEM_NAME,q);
